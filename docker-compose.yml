services:
  dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    working_dir: /app/rustfolio

    command:
      ["/usr/local/cargo/bin/cargo", "watch",
       "--poll",
       "-w", "src",
       "-w", "Cargo.toml",
       "--why",
       "-x", "run"]

    env_file:
      - .env

    environment:
      - RUST_LOG=info
      - SQLX_OFFLINE=false
      - DEV_RESET_DB_ON_MIGRATION_MISMATCH=1
      - APP_DIR=/app/rustfolio
      - DEV_RESET_DB_ON_MIGRATION_MISMATCH=1

    ports:
      - "8080:8080"

    volumes:
      - ./:/app:cached
      - app-data:/app/data
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target-cache:/app/rustfolio/target

    tty: true
    stdin_open: true
    restart: unless-stopped

volumes:
  cargo-registry:
  cargo-git:
  target-cache:
  app-data:
